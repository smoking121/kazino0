import random
import time
import asyncio
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes
)


INITIAL_BALANCE = 100
WAIT_TIME = 600 #Ð·Ð´ÐµÑÑŒ Ñ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸ ÐºÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹ Ð´Ð°Ð±Ñ‹ Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ
class PlayerProfile:
    def __init__(self, telegram_id):
        self.telegram_id = telegram_id
        self.balance = INITIAL_BALANCE
        self.last_refill = 0 #ÑÐ¾Ð·Ð´Ð°Ð» ÐºÐ»Ð°ÑÑ, Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½Ð½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð³Ñ€Ð¾ÐºÐ°
    def can_refill(self):
        return time.time() - self.last_refill >= WAIT_TIME


    def refill_balance(self):
        if self.can_refill():
            self.balance = INITIAL_BALANCE
            self.last_refill = time.time()
            return True
        return False #ÑÐ¾Ð·Ð´Ð°Ð» ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ°, ÐµÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð¸ÑÑŒ Ð´ÐµÐ½ÑŒÐ³Ð¸
        self.past_games = []
        self.wins_count = 0
        self.losses_count = 0
        self.total_won = 0
        self.total_lost = 0 #Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¸Ð³Ñ€


    def get_wait_time(self):
        remaining = WAIT_TIME - (time.time() - self.last_refill)
        return max(0, int(remaining)) #Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð¼ÐµÑ‚Ð¾Ð´ get_wait_time, Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ð¼ÐµÐ¶Ð´Ñƒ Ð²Ñ‹Ð´Ð°Ñ‡ÐµÐ¹ Ð´ÐµÐ½ÐµÐ³


    def record_game(self, game_mode, bet_kind, outcome, points):
        self.past_games.append({
            'mode': game_mode,
            'bet': bet_kind,
            'outcome': outcome,
            'points': points,
            'timestamp': time.strftime("%Y-%m-%d %H:%M:%S")
        })    #Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð¼ÐµÑ‚Ð¾Ð´ record_game, Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¸Ð³Ñ€Ñ‹
        if outcome == 'win':
            self.wins_count += 1
            self.total_won += points
        else:
            self.losses_count += 1
            self.total_lost += points

        if len(self.past_games) > 20:
            self.past_games.pop(0) #Ð·Ð´ÐµÑÑŒ Ñ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ñ€Ð¸ Ð¸Ð³Ñ€Ðµ
player_accounts = {} #Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¹ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð², ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð¹Ð´ÑƒÑ‚ Ð² Ð±Ð¾Ñ‚Ð°


def get_player_profile(user_id):
    if user_id not in player_accounts:
        player_accounts[user_id] = PlayerProfile(user_id)
    return player_accounts[user_id]  #Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð¼ÐµÑ‚Ð¾Ð´ get_player_profile, Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸ÑÑÑ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¾
#ÑÐ¾Ð·Ð´Ð°ÑŽ Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ Ð¼ÐµÐ½ÑŽÑˆÐºÑƒ ÑÐ²Ð¾ÐµÐ³Ð¾ ÐºÐ°Ð·Ð¸Ð½Ð¾ 


def create_main_menu():
    menu = [
        [InlineKeyboardButton("ðŸŽ² ÐšÑƒÐ±Ð¸Ðº", callback_data='roll_game')],
        [InlineKeyboardButton("ðŸ€ Ð‘Ð°ÑÐºÐµÑ‚Ð±Ð¾Ð»", callback_data='hoop_game')],
        [InlineKeyboardButton("âš½ Ð¤ÑƒÑ‚Ð±Ð¾Ð»", callback_data='goal_game')],
        [InlineKeyboardButton("ðŸŽ¯ Ð”Ð°Ñ€Ñ‚Ñ", callback_data='dart_game')],
        [
            InlineKeyboardButton("ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°", callback_data='performance'),
            InlineKeyboardButton("ðŸ’° ÐœÐ¾Ð½ÐµÑ‚Ñ‹", callback_data='refill_balance')
        ],
        [
            InlineKeyboardButton("â„¹ï¸ Ð‘Ð°Ð»Ð°Ð½Ñ", callback_data='current_balance'),
            InlineKeyboardButton("ðŸ’¸ ÐŸÐµÑ€ÐµÐ´Ð°Ñ‚ÑŒ Ð¼Ð¾Ð½ÐµÑ‚Ñ‹", callback_data='send_points')
        ]
    ]
    return InlineKeyboardMarkup(menu)


def create_dice_menu():
    menu = [
        [InlineKeyboardButton(">3 (x2)", callback_data='roll_high')],
        [InlineKeyboardButton("<3 (x2)", callback_data='roll_low')],
        [InlineKeyboardButton("Ð§ÐµÑ‚Ð½Ð¾Ðµ (x2)", callback_data='roll_even')],
        [InlineKeyboardButton("ÐÐµÑ‡ÐµÑ‚Ð½Ð¾Ðµ (x2)", callback_data='roll_odd')],
        [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='return_to_menu')]
    ]
    return InlineKeyboardMarkup(menu) #ÑÐ¾Ð·Ð´Ð°ÑŽ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ ÐºÑƒÐ±Ð¸ÐºÐ°


def create_sport_menu(game_mode):
    icon = "ðŸ€" if game_mode == "hoop" else "âš½" if game_mode == "goal" else "ðŸŽ¯"
    menu = [
        [InlineKeyboardButton(f"{icon} ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ (x2)", callback_data=f'{game_mode}_miss')],
        [InlineKeyboardButton(f"{icon} ÐŸÐ¾Ð¿Ð°Ð´ÐµÑ‚ (x2)", callback_data=f'{game_mode}_hit')],
        [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='return_to_menu')]
    ]
    return InlineKeyboardMarkup(menu) #ÑÐ¾Ð·Ð´Ð°ÑŽ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ Ñ„ÑƒÑ‚Ð±Ð¾Ð»Ð° Ð¸ Ð±Ð°ÑÐºÐµÑ‚Ð±Ð¾Ð»Ð°


def create_darts_menu():
    menu = [
        [InlineKeyboardButton("ðŸŽ¯ Ð’ ÑÐ±Ð»Ð¾Ñ‡ÐºÐ¾ (x5)", callback_data='dart_bullseye')],
        [InlineKeyboardButton("ðŸŽ¯ Ð’Ð½ÐµÑˆÐ½ÐµÐµ ÐºÐ¾Ð»ÑŒÑ†Ð¾ (x3)", callback_data='dart_outer')],
        [InlineKeyboardButton("ðŸŽ¯ Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐµ ÐºÐ¾Ð»ÑŒÑ†Ð¾ (x2)", callback_data='dart_inner')],
        [InlineKeyboardButton("ðŸŽ¯ ÐŸÐ¾Ð¿Ð°Ð´Ð°Ð½Ð¸Ðµ (x1.5)", callback_data='dart_hit')],
        [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='return_to_menu')]
    ]
    return InlineKeyboardMarkup(menu) #ÑÐ¾Ð·Ð´Ð°ÑŽ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ Ð¸Ð³Ñ€Ñ‹ Ð² Ð´Ð°Ñ€Ñ‚Ñ, Ñ Ñ€Ð°Ð·Ð½Ñ‹Ð¼Ð¸ ÐºÐ¾ÑÑÑ„Ð¸Ñ†Ð¸ÑÐ½Ñ‚Ð°Ð¼Ð¸ Ð´Ð»Ñ Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹ÑˆÐ°


async def show_performance(update: Update, player: PlayerProfile):
    if not player.past_games:
        await update.callback_query.edit_message_text(
            text="ðŸ“Š Ð£ Ð²Ð°Ñ ÐµÑ‰Ðµ Ð½ÐµÑ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¸Ð³Ñ€",
            reply_markup=create_main_menu()
        )
        return
    games_played = player.wins_count + player.losses_count
    success_rate = (player.wins_count / games_played * 100) if games_played > 0 else 0
    net_result = player.total_won - player.total_lost
    performance_text = (
        f"ðŸ“Š ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°:\n"
        f"ðŸŽ® Ð’ÑÐµÐ³Ð¾ Ð¸Ð³Ñ€: {games_played}\n"
        f"âœ… Ð’Ñ‹Ð¸Ð³Ñ€Ñ‹ÑˆÐ¸: {player.wins_count} ({success_rate:.1f}%)\n"
        f"âŒ ÐŸÑ€Ð¾Ð¸Ð³Ñ€Ñ‹ÑˆÐ¸: {player.losses_count}\n"
        f"ðŸ’° Ð¡ÑƒÐ¼Ð¼Ð°Ñ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹Ñˆ: +{player.total_won}\n"
        f"ðŸ’¸ Ð¡ÑƒÐ¼Ð¼Ð°Ñ€Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ñ‹Ñˆ: -{player.total_lost}\n"
        f"ðŸ’µ Ð§Ð¸ÑÑ‚Ð°Ñ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒ: {f'+{net_result}' if net_result >= 0 else net_result}\n\n"
        f"â³ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð³Ñ€Ñ‹:\n"
    )  #ÑÐ¾Ð·Ð´Ð°ÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¸Ð³Ñ€
    for game in player.past_games[-5:][::-1]:
        icon = "ðŸŽ²" if game['mode'] == 'roll' else "ðŸ€" if game['mode'] == 'hoop' else "âš½" if game[
                                                                                                'mode'] == 'goal' else "ðŸŽ¯"
        result_icon = "ðŸŸ¢" if game['outcome'] == 'win' else "ðŸ”´"
        bet_kind = game['bet']
        points = game['points']
        game_time = game['timestamp'][11:16]

        performance_text += (
            f"{result_icon} {icon} {game['mode']} ({bet_kind}) "
            f"{'+' if game['outcome'] == 'win' else '-'}{abs(points)} "
            f"({game_time})\n"
        )  #Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð¸Ð³Ñ€ Ð² ÐºÐ°Ð·Ð¸Ð½Ð¾
    await update.callback_query.edit_message_text(
        text=performance_text,
        reply_markup=create_main_menu()
    )   #Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚ÑÑ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ñ‡ÐµÑ€ÐµÐ· Ð±Ð¾Ñ‚Ð°


async def start_bot(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    player = get_player_profile(update.effective_user.id)
    welcome_msg = (
        f"ðŸŽ° Ð˜Ð³Ñ€Ð¾Ð²Ð¾Ð¹ Ð±Ð¾Ñ‚ | Ð‘Ð°Ð»Ð°Ð½Ñ: {player.balance} Ð¼Ð¾Ð½ÐµÑ‚\n\n"
        "Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n"
        "/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼\n"
        "/help - ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ\n"
        "/kurs - Ð£Ð·Ð½Ð°Ñ‚ÑŒ ÐºÑƒÑ€Ñ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð°\n\n"
        "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸Ð³Ñ€Ñƒ:"
    )
    await update.message.reply_text(
        welcome_msg,
        reply_markup=create_main_menu()
    )  #Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start Ð² Ð±Ð¾Ñ‚Ðµ


async def show_help(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    help_msg = (
        "ðŸ†˜ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ð¿Ð¾ Ð±Ð¾Ñ‚Ñƒ:\n\n"
        "ðŸŽ° Ð­Ñ‚Ð¾ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð¹ Ð±Ð¾Ñ‚ Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÐ¼Ð¸ ÐºÐ°Ð·Ð¸Ð½Ð¾. Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¸Ð³Ñ€Ñ‹:\n"
        "- ðŸŽ² ÐšÑƒÐ±Ð¸Ðº\n- ðŸ€ Ð‘Ð°ÑÐºÐµÑ‚Ð±Ð¾Ð»\n- âš½ Ð¤ÑƒÑ‚Ð±Ð¾Ð»\n- ðŸŽ¯ Ð”Ð°Ñ€Ñ‚Ñ\n\n"
        "ðŸ’° Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ñ‚ÑŒ Ð¼Ð¾Ð½ÐµÑ‚Ñ‹ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¼\n"
        "ðŸ“Š ÐŸÑ€Ð¾ÑÐ¼Ð°Ñ‚Ñ€Ð¸Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ÑÐ²Ð¾Ð¸Ñ… Ð¸Ð³Ñ€\n\n"
        "Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹, Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº @skyhardcore"
    )
    await update.message.reply_text(help_msg, reply_markup=create_main_menu())    #Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help  Ð² Ð±Ð¾Ñ‚Ðµ


async def show_exchange_rate(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    try:
        response = requests.get('https://www.cbr-xml-daily.ru/daily_json.js')
        data = response.json()
        usd_value = data['Valute']['USD']['Value']    #Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /kurs, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¾Ñ„Ñ„ ÐºÑƒÑ€Ñ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð° Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½ÑÐ¹Ñ‰Ð¸Ð¹ Ð´ÐµÐ½ÑŒ Ñ Ð¾Ñ„Ñ„ ÑÐ°Ð¹Ñ‚Ð° Ð Ñ„
        rate_msg = (
            f"ðŸ’µ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÐºÑƒÑ€Ñ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð° (Ð¦Ð‘ Ð Ð¤):\n"
            f"1 USD = {usd_value:.2f} RUB\n\n"
            f"ðŸ“… Ð”Ð°Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ: {data['Date'][:10]}"
        )
        await update.message.reply_text(rate_msg, reply_markup=create_main_menu())        #Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /kurs, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¾Ñ„Ñ„ ÐºÑƒÑ€Ñ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð° Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½ÑÐ¹Ñ‰Ð¸Ð¹ Ð´ÐµÐ½ÑŒ Ñ Ð¾Ñ„Ñ„ ÑÐ°Ð¹Ñ‚Ð° Ð Ñ„
    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÐºÑƒÑ€ÑÐ°: {e}")
        await update.message.reply_text(
            "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÑƒÑ€Ñ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.",
            reply_markup=create_main_menu()
        )


async def handle_button(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    try:
        await query.answer()
        player = get_player_profile(update.effective_user.id) # Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð² Ð±Ð¾Ñ‚Ðµ
        if query.data == 'roll_game':
            await query.edit_message_text(
                text="ðŸŽ² Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¸Ð¿ ÑÑ‚Ð°Ð²ÐºÐ¸:",
                reply_markup=create_dice_menu()
            )   # Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¸Ð³Ñ€Ñ‹ Ð² ÐºÑƒÐ±Ð¸Ðº
        elif query.data == 'performance':
            await show_performance(update, player)   #ÐºÐ½Ð¾Ð¿ÐºÐ° ÑÑ‚Ð°Ñ‚Ð¸Ñ‚ÑÑ‚Ð¸ÐºÐ¸
        elif query.data in ['hoop_game', 'goal_game', 'dart_game']:
            game_mode = query.data.split('_')[0]
            game_title = {
                'hoop': "ðŸ€ ÐŸÐ¾Ð¿Ð°Ð´ÐµÑ‚ Ð»Ð¸ Ð¼ÑÑ‡ Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ?",
                'goal': "âš½ Ð—Ð°Ð±ÑŒÐµÑ‚ Ð»Ð¸ Ð¸Ð³Ñ€Ð¾Ðº Ð³Ð¾Ð»?",
                'dart': "ðŸŽ¯ ÐšÑƒÐ´Ð° Ð¿Ð¾Ð¿Ð°Ð´ÐµÑ‚ Ð´Ñ€Ð¾Ñ‚Ð¸Ðº?"
            }[game_mode]  # Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð±Ð°ÑÐºÐµÑ‚Ð±Ð¾Ð»Ð° Ð¸ Ñ„ÑƒÑ‚Ð±Ð¾Ð»Ð°
            if game_mode == 'dart':
                await query.edit_message_text(
                    text=f"{game_title}\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ‚Ð°Ð²ÐºÑƒ:",
                    reply_markup=create_darts_menu()
                )
            else:
                await query.edit_message_text(
                    text=f"{game_title}\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÑ‚Ð°Ð²ÐºÑƒ:",
                    reply_markup=create_sport_menu(game_mode)
                )   #Ð²Ñ‹Ð±Ð¾Ñ€ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ Ð¸Ð³Ñ€Ñ‹
        elif any(query.data.startswith(game) for game in
                 ['roll_', 'hoop_', 'goal_', 'dart_']):
            parts = query.data.split('_')
            game_mode = parts[0]
            bet_kind = parts[1]

            context.user_data['game_mode'] = game_mode
            context.user_data['bet_kind'] = bet_kind   #Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÑ‚Ð°Ð²Ð¾Ðº Ð² ÐºÐ°Ð·Ð¸Ð½Ð¾
            bet_title = {
                'high': ">3", 'low': "<3", 'even': "Ð§ÐµÑ‚Ð½Ð¾Ðµ", 'odd': "ÐÐµÑ‡ÐµÑ‚Ð½Ð¾Ðµ",
                'miss': "ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚", 'hit': "ÐŸÐ¾Ð¿Ð°Ð´ÐµÑ‚",
                'bullseye': "Ð’ ÑÐ±Ð»Ð¾Ñ‡ÐºÐ¾", 'outer': "Ð’Ð½ÐµÑˆÐ½ÐµÐµ ÐºÐ¾Ð»ÑŒÑ†Ð¾",
                'inner': "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐµ ÐºÐ¾Ð»ÑŒÑ†Ð¾", 'hit': "ÐŸÐ¾Ð¿Ð°Ð´Ð°Ð½Ð¸Ðµ"
            }[bet_kind]

            await query.edit_message_text(
                text=f"{'ðŸŽ²' if game_mode == 'roll' else 'ðŸ€' if game_mode == 'hoop' else 'âš½' if game_mode == 'goal' else 'ðŸŽ¯'} "
                     f"Ð¡Ñ‚Ð°Ð²ÐºÐ°: {bet_title}\n"
                     f"ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ: {player.balance}\n\n"
                     "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ ÑÑ‚Ð°Ð²ÐºÐ¸:",
                reply_markup=None
            )     #Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾ Ð²Ð²Ð¾Ð´Ðµ ÑÑƒÐ¼Ð¼Ñ‹ ÑÑ‚Ð°Ð²ÐºÐ¸
        elif query.data == 'refill_balance':
            if player.balance <= 0:
                if player.can_refill():
                    player.balance = INITIAL_BALANCE
                    player.last_refill = time.time()
                    await query.edit_message_text(
                        text=f"ðŸ’° Ð’Ð°Ð¼ Ð½Ð°Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¾ {INITIAL_BALANCE} Ð¼Ð¾Ð½ÐµÑ‚!\nÐ‘Ð°Ð»Ð°Ð½Ñ: {player.balance}",
                        reply_markup=create_main_menu()
                    )    #Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
                else:
                    remaining = player.get_wait_time()
                    minutes, seconds = divmod(remaining, 60)
                    await query.edit_message_text(
                        text=f"â³ Ð’Ñ‹ ÑÐ¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð½ÐµÑ‚Ñ‹ Ñ‡ÐµÑ€ÐµÐ· {minutes} Ð¼Ð¸Ð½ {seconds} ÑÐµÐº",
                        reply_markup=create_main_menu()
                    )
            else:
                await query.edit_message_text(
                    text=f"ðŸ’° Ð£ Ð²Ð°Ñ ÐµÑ‰Ðµ ÐµÑÑ‚ÑŒ Ð¼Ð¾Ð½ÐµÑ‚Ñ‹: {player.balance}",
                    reply_markup=create_main_menu()
                )    #Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ
        elif query.data == 'current_balance':
            await query.edit_message_text(
                text=f"ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ: {player.balance} Ð¼Ð¾Ð½ÐµÑ‚",
                reply_markup=create_main_menu()
            )  #Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð±Ð°Ð»Ð°Ð½ÑÐ°
        elif query.data == 'send_points':
            context.user_data['transfer_state'] = 'awaiting_user'
            await query.edit_message_text(
                text="ðŸ’¸ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼Ñƒ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‚ÑŒ Ð¼Ð¾Ð½ÐµÑ‚Ñ‹:",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='return_to_menu')]])
            )   #Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð° Ð´ÐµÐµÐ½ÐµÐ³ Ð² Ð±Ð¾Ñ‚Ðµ Ð¾Ñ‚ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ðº Ð¸Ð³Ñ€Ð¾ÐºÑƒ Ð¿Ð¾ ID  Ð² Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ð¼Ðµ
