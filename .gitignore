import random
import time
import asyncio
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes
)


INITIAL_BALANCE = 100
WAIT_TIME = 600 #Ð·Ð´ÐµÑÑŒ Ñ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸ ÐºÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹ Ð´Ð°Ð±Ñ‹ Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ
class PlayerProfile:
    def __init__(self, telegram_id):
        self.telegram_id = telegram_id
        self.balance = INITIAL_BALANCE
        self.last_refill = 0 #ÑÐ¾Ð·Ð´Ð°Ð» ÐºÐ»Ð°ÑÑ, Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½Ð½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð³Ñ€Ð¾ÐºÐ°
    def can_refill(self):
        return time.time() - self.last_refill >= WAIT_TIME


    def refill_balance(self):
        if self.can_refill():
            self.balance = INITIAL_BALANCE
            self.last_refill = time.time()
            return True
        return False #ÑÐ¾Ð·Ð´Ð°Ð» ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ°, ÐµÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð¸ÑÑŒ Ð´ÐµÐ½ÑŒÐ³Ð¸
        self.past_games = []
        self.wins_count = 0
        self.losses_count = 0
        self.total_won = 0
        self.total_lost = 0 #Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¸Ð³Ñ€


    def get_wait_time(self):
        remaining = WAIT_TIME - (time.time() - self.last_refill)
        return max(0, int(remaining)) #Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð¼ÐµÑ‚Ð¾Ð´ get_wait_time, Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ð¼ÐµÐ¶Ð´Ñƒ Ð²Ñ‹Ð´Ð°Ñ‡ÐµÐ¹ Ð´ÐµÐ½ÐµÐ³


    def record_game(self, game_mode, bet_kind, outcome, points):
        self.past_games.append({
            'mode': game_mode,
            'bet': bet_kind,
            'outcome': outcome,
            'points': points,
            'timestamp': time.strftime("%Y-%m-%d %H:%M:%S")
        })    #Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð¼ÐµÑ‚Ð¾Ð´ record_game, Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¸Ð³Ñ€Ñ‹
        if outcome == 'win':
            self.wins_count += 1
            self.total_won += points
        else:
            self.losses_count += 1
            self.total_lost += points

        if len(self.past_games) > 20:
            self.past_games.pop(0) #Ð·Ð´ÐµÑÑŒ Ñ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ñ€Ð¸ Ð¸Ð³Ñ€Ðµ
player_accounts = {} #Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¹ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð², ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð¹Ð´ÑƒÑ‚ Ð² Ð±Ð¾Ñ‚Ð°


def get_player_profile(user_id):
    if user_id not in player_accounts:
        player_accounts[user_id] = PlayerProfile(user_id)
    return player_accounts[user_id]  #Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» Ð¼ÐµÑ‚Ð¾Ð´ get_player_profile, Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸ÑÑÑ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¾
#ÑÐ¾Ð·Ð´Ð°ÑŽ Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ Ð¼ÐµÐ½ÑŽÑˆÐºÑƒ ÑÐ²Ð¾ÐµÐ³Ð¾ ÐºÐ°Ð·Ð¸Ð½Ð¾ 


def create_main_menu():
    menu = [
        [InlineKeyboardButton("ðŸŽ² ÐšÑƒÐ±Ð¸Ðº", callback_data='roll_game')],
        [InlineKeyboardButton("ðŸ€ Ð‘Ð°ÑÐºÐµÑ‚Ð±Ð¾Ð»", callback_data='hoop_game')],
        [InlineKeyboardButton("âš½ Ð¤ÑƒÑ‚Ð±Ð¾Ð»", callback_data='goal_game')],
        [InlineKeyboardButton("ðŸŽ¯ Ð”Ð°Ñ€Ñ‚Ñ", callback_data='dart_game')],
        [
            InlineKeyboardButton("ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°", callback_data='performance'),
            InlineKeyboardButton("ðŸ’° ÐœÐ¾Ð½ÐµÑ‚Ñ‹", callback_data='refill_balance')
        ],
        [
            InlineKeyboardButton("â„¹ï¸ Ð‘Ð°Ð»Ð°Ð½Ñ", callback_data='current_balance'),
            InlineKeyboardButton("ðŸ’¸ ÐŸÐµÑ€ÐµÐ´Ð°Ñ‚ÑŒ Ð¼Ð¾Ð½ÐµÑ‚Ñ‹", callback_data='send_points')
        ]
    ]
    return InlineKeyboardMarkup(menu)


def create_dice_menu():
    menu = [
        [InlineKeyboardButton(">3 (x2)", callback_data='roll_high')],
        [InlineKeyboardButton("<3 (x2)", callback_data='roll_low')],
        [InlineKeyboardButton("Ð§ÐµÑ‚Ð½Ð¾Ðµ (x2)", callback_data='roll_even')],
        [InlineKeyboardButton("ÐÐµÑ‡ÐµÑ‚Ð½Ð¾Ðµ (x2)", callback_data='roll_odd')],
        [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='return_to_menu')]
    ]
    return InlineKeyboardMarkup(menu) #ÑÐ¾Ð·Ð´Ð°ÑŽ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ ÐºÑƒÐ±Ð¸ÐºÐ°


def create_sport_menu(game_mode):
    icon = "ðŸ€" if game_mode == "hoop" else "âš½" if game_mode == "goal" else "ðŸŽ¯"
    menu = [
        [InlineKeyboardButton(f"{icon} ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ (x2)", callback_data=f'{game_mode}_miss')],
        [InlineKeyboardButton(f"{icon} ÐŸÐ¾Ð¿Ð°Ð´ÐµÑ‚ (x2)", callback_data=f'{game_mode}_hit')],
        [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='return_to_menu')]
    ]
    return InlineKeyboardMarkup(menu) #ÑÐ¾Ð·Ð´Ð°ÑŽ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ Ñ„ÑƒÑ‚Ð±Ð¾Ð»Ð° Ð¸ Ð±Ð°ÑÐºÐµÑ‚Ð±Ð¾Ð»Ð°
