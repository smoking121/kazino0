import random
import time
import asyncio
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes
)


INITIAL_BALANCE = 100
WAIT_TIME = 600 #–∑–¥–µ—Å—å —è –¥–æ–±–∞–≤–∏–ª –±–∞–∑–æ–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–∞–±—ã –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
class PlayerProfile:
    def __init__(self, telegram_id):
        self.telegram_id = telegram_id
        self.balance = INITIAL_BALANCE
        self.last_refill = 0 #—Å–æ–∑–¥–∞–ª –∫–ª–∞—Å—Å, –¥–ª—è —Ö—Ä–∞–Ω–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞
    def can_refill(self):
        return time.time() - self.last_refill >= WAIT_TIME


    def refill_balance(self):
        if self.can_refill():
            self.balance = INITIAL_BALANCE
            self.last_refill = time.time()
            return True
        return False #—Å–æ–∑–¥–∞–ª —Å–∏—Å—Ç–µ–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞, –µ—Å–ª–∏ —É –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –¥–µ–Ω—å–≥–∏
        self.past_games = []
        self.wins_count = 0
        self.losses_count = 0
        self.total_won = 0
        self.total_lost = 0 #–¥–æ–±–∞–≤–∏–ª —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä


    def get_wait_time(self):
        remaining = WAIT_TIME - (time.time() - self.last_refill)
        return max(0, int(remaining)) #–¥–æ–±–∞–≤–∏–ª –º–µ—Ç–æ–¥ get_wait_time, –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è –º–µ–∂–¥—É –≤—ã–¥–∞—á–µ–π –¥–µ–Ω–µ–≥


    def record_game(self, game_mode, bet_kind, outcome, points):
        self.past_games.append({
            'mode': game_mode,
            'bet': bet_kind,
            'outcome': outcome,
            'points': points,
            'timestamp': time.strftime("%Y-%m-%d %H:%M:%S")
        })    #–¥–æ–±–∞–≤–∏–ª –º–µ—Ç–æ–¥ record_game, –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–≥—Ä—ã
        if outcome == 'win':
            self.wins_count += 1
            self.total_won += points
        else:
            self.losses_count += 1
            self.total_lost += points

        if len(self.past_games) > 20:
            self.past_games.pop(0) #–∑–¥–µ—Å—å —è –¥–æ–±–∞–≤–∏–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∏–≥—Ä–µ
player_accounts = {} #—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–π–¥—É—Ç –≤ –±–æ—Ç–∞


def get_player_profile(user_id):
    if user_id not in player_accounts:
        player_accounts[user_id] = PlayerProfile(user_id)
    return player_accounts[user_id]  #–¥–æ–±–∞–≤–∏–ª –º–µ—Ç–æ–¥ get_player_profile, –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è—è—è –ø—Ä–æ—Ñ–∏–ª—è –∏–≥—Ä–æ–∫–∞–æ
#—Å–æ–∑–¥–∞—é –≥–ª–∞–≤–Ω—É—é –º–µ–Ω—é—à–∫—É —Å–≤–æ–µ–≥–æ –∫–∞–∑–∏–Ω–æ 


def create_main_menu():
    menu = [
        [InlineKeyboardButton("üé≤ –ö—É–±–∏–∫", callback_data='roll_game')],
        [InlineKeyboardButton("üèÄ –ë–∞—Å–∫–µ—Ç–±–æ–ª", callback_data='hoop_game')],
        [InlineKeyboardButton("‚öΩ –§—É—Ç–±–æ–ª", callback_data='goal_game')],
        [InlineKeyboardButton("üéØ –î–∞—Ä—Ç—Å", callback_data='dart_game')],
        [
            InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='performance'),
            InlineKeyboardButton("üí∞ –ú–æ–Ω–µ—Ç—ã", callback_data='refill_balance')
        ],
        [
            InlineKeyboardButton("‚ÑπÔ∏è –ë–∞–ª–∞–Ω—Å", callback_data='current_balance'),
            InlineKeyboardButton("üí∏ –ü–µ—Ä–µ–¥–∞—Ç—å –º–æ–Ω–µ—Ç—ã", callback_data='send_points')
        ]
    ]
    return InlineKeyboardMarkup(menu)


def create_dice_menu():
    menu = [
        [InlineKeyboardButton(">3 (x2)", callback_data='roll_high')],
        [InlineKeyboardButton("<3 (x2)", callback_data='roll_low')],
        [InlineKeyboardButton("–ß–µ—Ç–Ω–æ–µ (x2)", callback_data='roll_even')],
        [InlineKeyboardButton("–ù–µ—á–µ—Ç–Ω–æ–µ (x2)", callback_data='roll_odd')],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data='return_to_menu')]
    ]
    return InlineKeyboardMarkup(menu) #—Å–æ–∑–¥–∞—é –º–µ–Ω—é –¥–ª—è –∫—É–±–∏–∫–∞


def create_sport_menu(game_mode):
    icon = "üèÄ" if game_mode == "hoop" else "‚öΩ" if game_mode == "goal" else "üéØ"
    menu = [
        [InlineKeyboardButton(f"{icon} –ü—Ä–æ–ø—É—Å—Ç–∏—Ç (x2)", callback_data=f'{game_mode}_miss')],
        [InlineKeyboardButton(f"{icon} –ü–æ–ø–∞–¥–µ—Ç (x2)", callback_data=f'{game_mode}_hit')],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data='return_to_menu')]
    ]
    return InlineKeyboardMarkup(menu) #—Å–æ–∑–¥–∞—é –º–µ–Ω—é –¥–ª—è —Ñ—É—Ç–±–æ–ª–∞ –∏ –±–∞—Å–∫–µ—Ç–±–æ–ª–∞


def create_darts_menu():
    menu = [
        [InlineKeyboardButton("üéØ –í —è–±–ª–æ—á–∫–æ (x5)", callback_data='dart_bullseye')],
        [InlineKeyboardButton("üéØ –í–Ω–µ—à–Ω–µ–µ –∫–æ–ª—å—Ü–æ (x3)", callback_data='dart_outer')],
        [InlineKeyboardButton("üéØ –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∫–æ–ª—å—Ü–æ (x2)", callback_data='dart_inner')],
        [InlineKeyboardButton("üéØ –ü–æ–ø–∞–¥–∞–Ω–∏–µ (x1.5)", callback_data='dart_hit')],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data='return_to_menu')]
    ]
    return InlineKeyboardMarkup(menu) #—Å–æ–∑–¥–∞—é –º–µ–Ω—é –¥–ª—è –∏–≥—Ä—ã –≤ –¥–∞—Ä—Ç—Å, —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ—ç—ç—Ñ–∏—Ü–∏—ç–Ω—Ç–∞–º–∏ –¥–ª—è –≤—ã–∏–≥—Ä—ã—à–∞


async def show_performance(update: Update, player: PlayerProfile):
    if not player.past_games:
        await update.callback_query.edit_message_text(
            text="üìä –£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä",
            reply_markup=create_main_menu()
        )
        return
    games_played = player.wins_count + player.losses_count
    success_rate = (player.wins_count / games_played * 100) if games_played > 0 else 0
    net_result = player.total_won - player.total_lost
    performance_text = (
        f"üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
        f"üéÆ –í—Å–µ–≥–æ –∏–≥—Ä: {games_played}\n"
        f"‚úÖ –í—ã–∏–≥—Ä—ã—à–∏: {player.wins_count} ({success_rate:.1f}%)\n"
        f"‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à–∏: {player.losses_count}\n"
        f"üí∞ –°—É–º–º–∞—Ä–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: +{player.total_won}\n"
        f"üí∏ –°—É–º–º–∞—Ä–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã—à: -{player.total_lost}\n"
        f"üíµ –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: {f'+{net_result}' if net_result >= 0 else net_result}\n\n"
        f"‚è≥ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã:\n"
    )  #—Å–æ–∑–¥–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä
    for game in player.past_games[-5:][::-1]:
        icon = "üé≤" if game['mode'] == 'roll' else "üèÄ" if game['mode'] == 'hoop' else "‚öΩ" if game[
                                                                                                'mode'] == 'goal' else "üéØ"
        result_icon = "üü¢" if game['outcome'] == 'win' else "üî¥"
        bet_kind = game['bet']
        points = game['points']
        game_time = game['timestamp'][11:16]

        performance_text += (
            f"{result_icon} {icon} {game['mode']} ({bet_kind}) "
            f"{'+' if game['outcome'] == 'win' else '-'}{abs(points)} "
            f"({game_time})\n"
        )  #–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–≥—Ä –≤ –∫–∞–∑–∏–Ω–æ
    await update.callback_query.edit_message_text(
        text=performance_text,
        reply_markup=create_main_menu()
    )   #–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç—Å—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –±–æ—Ç–∞


async def start_bot(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    player = get_player_profile(update.effective_user.id)
    welcome_msg = (
        f"üé∞ –ò–≥—Ä–æ–≤–æ–π –±–æ—Ç | –ë–∞–ª–∞–Ω—Å: {player.balance} –º–æ–Ω–µ—Ç\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n"
        "/help - –ü–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É\n"
        "/kurs - –£–∑–Ω–∞—Ç—å –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:"
    )
    await update.message.reply_text(
        welcome_msg,
        reply_markup=create_main_menu()
    )  #–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start –≤ –±–æ—Ç–µ
