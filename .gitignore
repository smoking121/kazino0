import random
import time
import asyncio
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes
)

INITIAL_BALANCE = 100
WAIT_TIME = 600 #–∑–¥–µ—Å—å —è –¥–æ–±–∞–≤–∏–ª –±–∞–∑–æ–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–∞–±—ã –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
class PlayerProfile:
    def __init__(self, telegram_id):
        self.telegram_id = telegram_id
        self.balance = INITIAL_BALANCE
        self.last_refill = 0 #—Å–æ–∑–¥–∞–ª –∫–ª–∞—Å—Å, –¥–ª—è —Ö—Ä–∞–Ω–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞
    def can_refill(self):
        return time.time() - self.last_refill >= WAIT_TIME

    def refill_balance(self):
        if self.can_refill():
            self.balance = INITIAL_BALANCE
            self.last_refill = time.time()
            return True
        return False #—Å–æ–∑–¥–∞–ª —Å–∏—Å—Ç–µ–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞, –µ—Å–ª–∏ —É –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –¥–µ–Ω—å–≥–∏
        self.past_games = []
        self.wins_count = 0
        self.losses_count = 0
        self.total_won = 0
        self.total_lost = 0 #–¥–æ–±–∞–≤–∏–ª —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä
    def get_wait_time(self):
        remaining = WAIT_TIME - (time.time() - self.last_refill)
        return max(0, int(remaining)) #–¥–æ–±–∞–≤–∏–ª –º–µ—Ç–æ–¥ get_wait_time, –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è –º–µ–∂–¥—É –≤—ã–¥–∞—á–µ–π –¥–µ–Ω–µ–≥
    def record_game(self, game_mode, bet_kind, outcome, points):
        self.past_games.append({
            'mode': game_mode,
            'bet': bet_kind,
            'outcome': outcome,
            'points': points,
            'timestamp': time.strftime("%Y-%m-%d %H:%M:%S")
        })    #–¥–æ–±–∞–≤–∏–ª –º–µ—Ç–æ–¥ record_game, –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–≥—Ä—ã
        if outcome == 'win':
            self.wins_count += 1
            self.total_won += points
        else:
            self.losses_count += 1
            self.total_lost += points

        if len(self.past_games) > 20:
            self.past_games.pop(0) #–∑–¥–µ—Å—å —è –¥–æ–±–∞–≤–∏–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∏–≥—Ä–µ
player_accounts = {} #—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–π–¥—É—Ç –≤ –±–æ—Ç–∞
def get_player_profile(user_id):
    if user_id not in player_accounts:
        player_accounts[user_id] = PlayerProfile(user_id)
    return player_accounts[user_id]  #–¥–æ–±–∞–≤–∏–ª –º–µ—Ç–æ–¥ get_player_profile, –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è—è—è –ø—Ä–æ—Ñ–∏–ª—è –∏–≥—Ä–æ–∫–∞–æ
#—Å–æ–∑–¥–∞—é –≥–ª–∞–≤–Ω—É—é –º–µ–Ω—é—à–∫—É —Å–≤–æ–µ–≥–æ –∫–∞–∑–∏–Ω–æ 
def create_main_menu():
    menu = [
        [InlineKeyboardButton("üé≤ –ö—É–±–∏–∫", callback_data='roll_game')],
        [InlineKeyboardButton("üèÄ –ë–∞—Å–∫–µ—Ç–±–æ–ª", callback_data='hoop_game')],
        [InlineKeyboardButton("‚öΩ –§—É—Ç–±–æ–ª", callback_data='goal_game')],
        [InlineKeyboardButton("üéØ –î–∞—Ä—Ç—Å", callback_data='dart_game')],
        [
            InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='performance'),
            InlineKeyboardButton("üí∞ –ú–æ–Ω–µ—Ç—ã", callback_data='refill_balance')
        ],
        [
            InlineKeyboardButton("‚ÑπÔ∏è –ë–∞–ª–∞–Ω—Å", callback_data='current_balance'),
            InlineKeyboardButton("üí∏ –ü–µ—Ä–µ–¥–∞—Ç—å –º–æ–Ω–µ—Ç—ã", callback_data='send_points')
        ]
    ]
    return InlineKeyboardMarkup(menu)
